<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Quiz client</title>
<style>
:root{
  --bg:#0b0b0b; --card:#161616; --accent:#0066ff;
  --ok:#00c853; --bad:#ff1744; --muted:#bdbdbd; --glass: rgba(255,255,255,0.03);
  --gutter:12px;
  --control-height:44px;
}
*{box-sizing:border-box}
html, body { overscroll-behavior: none; touch-action: manipulation; height:100%; }
body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:#fff;min-height:100vh}
.container{max-width:1100px;margin:12px auto;padding:16px;display:flex;flex-direction:column;gap:16px;transition:padding-top .25s}

/* collapsed menu padding helper */
.container.menu-collapsed { padding-top: 8px; }

/* top grid: left (controls) + right (buttons) */
.top-grid{
  display:grid;
  grid-template-columns: 1fr 200px;
  gap:var(--gutter);
  align-items:center;
  width:100%;
  transition:transform .25s, opacity .2s;
}

/* left/right stacks */
.left-stack{display:flex;flex-direction:column;gap:var(--gutter)}
.right-stack{display:flex;flex-direction:column;gap:var(--gutter);align-items:stretch;justify-content:center}

/* studyMethodRow: visible when needed; reduced gap to topic */
#studyMethodRow {
  display: none;
  width: 100%;
  margin-top: calc(var(--gutter) / 2); /* reduced gap between Topic and Method */
}
/* helper class used when studyMethodRow is inserted after top-grid */
.top-wide { grid-column: 1 / -1; }

/* fields — uniform height */
.field input, .field select{
  height: var(--control-height);
  line-height: normal;
  width:100%;padding:0 12px;border-radius:10px;border:0;background:var(--glass);color:#fff;font-size:15px;
  display:flex;align-items:center;
  -webkit-appearance: none;
  -moz-appearance: none;
  appearance: none;
}
.field input::placeholder{ color: rgba(255,255,255,0.6); }

/* select placeholder styling */
.field select { color: #fff; }
.field select:invalid { color: rgba(255,255,255,0.6); }
.field select option[disabled] { color: rgba(255,255,255,0.6); }

/* buttons */
.btn{
  height: var(--control-height);
  border-radius:10px;border:0;font-size:15px;cursor:pointer;padding:0 14px;
  display:inline-flex;align-items:center;justify-content:center;
}
.btn.full{width:100%}
#join{background:var(--accent);color:#fff}
#start{background:#22c55e;color:#fff}
#rating{background:#ffb300;color:#111}

/* Card / question area */
.card{
  padding:18px;background:var(--card);border-radius:12px;margin-top:8px;display:flex;flex-direction:column;gap:12px;
  transition:height .2s;
}

.qtext{font-size:20px;text-align:center;margin:6px 0}
.meta{font-size:13px;color:var(--muted);text-align:center}
.image-wrap{text-align:center;display:flex;align-items:flex-start;justify-content:center;overflow:hidden}
.image-wrap img{
  display:block;
  max-width:100%;
  width:auto;
  height:auto;
  max-height:80vh;
  margin: 0 auto;
  border-radius:8px;
  object-fit:contain;
}

/* progress and choices */
.progress{height:12px;background:rgba(255,255,255,0.04);border-radius:8px;overflow:hidden;margin:8px auto 12px auto;width:100%}
.progress>i{display:block;height:100%;background:linear-gradient(90deg,#ef5350,#29b6f6);width:0%;transition:width 300ms linear}
.choices{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin:0 auto;width:100%;max-width:920px}
.choice{padding:14px;border-radius:12px;font-weight:800;color:#fff;text-align:center;cursor:pointer;user-select:none;outline:none;box-shadow:0 6px 18px rgba(0,0,0,0.6)}
.choice.disabled{opacity:0.7;pointer-events:none}.choice.pressed{transform:translateY(3px)}
.choice.correct{border:4px solid var(--ok)}.choice.wrong{border:4px solid var(--bad)}
.a{background:#ef5350}.b{background:#ffd54f;color:#111}.c{background:#66bb6a}.d{background:#29b6f6;color:#111}

/* modals */
.modal{position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:9999}
.box{background:#101010;padding:18px;border-radius:12px;max-width:760px;width:95%}
.results-table{width:100%;border-collapse:collapse}
.results-table th,.results-table td{padding:10px;border-bottom:1px solid rgba(255,255,255,0.03);text-align:left}
.result-1{background:linear-gradient(90deg,rgba(255,215,0,0.08),transparent)}

.flash-controls{display:flex;gap:8px;justify-content:center}
.flash-controls button{height:40px;border-radius:8px;padding:0 10px}

/* Responsive tweaks */
@media (max-width:920px){
  .top-grid{grid-template-columns: minmax(140px, 0.62fr) minmax(80px, 120px);gap:10px}
  :root{--control-height:42px}
}
@media (max-width:720px){
  .top-grid{grid-template-columns: minmax(120px, 1fr) minmax(70px, 100px);gap:8px;align-items:center}
  :root{--control-height:40px}
}
</style>
</head>
<body>

<div class="container" id="mainContainer">
  <div class="top-grid" id="topGrid">
    <div class="left-stack">
      <div class="field">
        <input id="name" placeholder="Ваше имя" aria-label="Ваше имя">
      </div>

      <div class="field">
        <select id="format" aria-label="Выбор формата" required>
          <option value="" disabled selected>Выбор формата</option>
          <option value="game">Игра</option>
          <option value="study">Обучение</option>
        </select>
      </div>

      <div class="field">
        <select id="topic" aria-label="Выбор темы" required>
          <option value="" disabled selected>Выбор темы</option>
        </select>
      </div>

      <!-- studyMethodRow stays here; will be moved temporarily after top-grid when needed -->
      <div class="field" id="studyMethodRow">
        <select id="studyMethod" aria-label="Метод обучения" required>
          <option value="" disabled selected>Метод обучения</option>
          <option value="flashcards">Flashcards</option>
          <option value="matching">Matching</option>
          <option value="typing">Typing</option>
          <option value="spaced">Spaced</option>
        </select>
      </div>
    </div>

    <div class="right-stack">
      <button id="join" class="btn full">Connect</button>
      <button id="start" class="btn full">Старт</button>
      <button id="rating" class="btn full">Рейтинг</button>
    </div>
  </div>

  <!-- placeholder slot for studyMethod when it should span full width -->
  <div id="studyMethodSlot"></div>

  <div class="card" id="gameCard" aria-live="polite">
    <div class="qtext" id="qtext">Ожидание игры...</div>
    <div class="meta" id="metaInQ">Вопросов в игре: 0</div>

    <div class="image-wrap" id="imageWrap" style="display:none"></div>

    <div class="progress" id="progress" style="display:none"><i id="progressBar"></i></div>

    <div class="choices" id="choices" aria-hidden="true">
      <div class="choice a" id="c0">A</div>
      <div class="choice b" id="c1">B</div>
      <div class="choice c" id="c2">C</div>
      <div class="choice d" id="c3">D</div>
    </div>

    <div id="studyArea" style="display:none">
      <div id="flashCard" style="text-align:center">
        <div id="cardTerm" style="font-size:22px;font-weight:700;margin:12px 0"></div>
        <div id="cardDef" style="font-size:18px;color:var(--muted);display:none"></div>
        <div class="flash-controls">
          <button id="showAnswer" class="btn">Показать ответ</button>
          <button id="knowBtn" class="btn" style="background:var(--ok)">Знаю</button>
          <button id="dontKnowBtn" class="btn" style="background:var(--bad)">Не знаю</button>
        </div>
      </div>
    </div>

    <div id="playersBox" style="margin-top:12px;color:var(--muted)"></div>
  </div>
</div>

<!-- Ratings modal -->
<div id="ratingsModal" class="modal"><div class="box">
  <div style="display:flex;justify-content:space-between;align-items:center"><h3 id="ratingsTitle" style="margin:0">Рейтинг</h3><button id="closeRatings" class="btn" style="height:36px">Закрыть</button></div>
  <table class="results-table" id="ratingsTable"><thead><tr><th>#</th><th>Игрок</th><th>Очки</th><th>Верных</th></tr></thead><tbody id="ratingsBody"></tbody></table>
</div></div>

<!-- Final modal -->
<div id="finalModal" class="modal"><div class="box">
  <div style="display:flex;justify-content:space-between;align-items:center"><h3 style="margin:0">Итоги игры</h3><button id="closeFinal" class="btn" style="height:36px">Закрыть</button></div>
  <table class="results-table" id="finalTable"><thead><tr><th>#</th><th>Игрок</th><th>Очки</th><th>Верных</th></tr></thead><tbody id="finalBody"></tbody></table>
</div></div>

<script>
/* Prevent pull-to-refresh on iOS Safari */
(function disablePullToRefresh() {
  let startY = 0;
  let maybePrevent = false;
  document.addEventListener('touchstart', function(e) {
    if (e.touches.length !== 1) return;
    startY = e.touches[0].screenY;
    maybePrevent = (window.scrollY === 0);
  }, {passive: true});
  document.addEventListener('touchmove', function(e) {
    if (!maybePrevent) return;
    const curY = e.touches[0].screenY;
    const deltaY = curY - startY;
    if (deltaY > 10) e.preventDefault();
  }, {passive: false});
})();

window.addEventListener('keydown', function(e) {
  if (e.key === 'F5' || ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'r')) e.preventDefault();
});

/* Refs */
const TURN_TIME = 12;
const nameInput = document.getElementById('name');
const joinBtn = document.getElementById('join');
const startBtn = document.getElementById('start');
const ratingBtn = document.getElementById('rating');
const topicSelect = document.getElementById('topic');
const formatSelect = document.getElementById('format');
const studyMethodRow = document.getElementById('studyMethodRow');
const studyMethodSlot = document.getElementById('studyMethodSlot');
const studyMethodSelect = document.getElementById('studyMethod');
const qtext = document.getElementById('qtext');
const metaInQ = document.getElementById('metaInQ');
const imageWrap = document.getElementById('imageWrap');
const progress = document.getElementById('progress');
const progressBar = document.getElementById('progressBar');
const choicesEls = [document.getElementById('c0'),document.getElementById('c1'),document.getElementById('c2'),document.getElementById('c3')];
const playersBox = document.getElementById('playersBox');

const ratingsModal = document.getElementById('ratingsModal');
const ratingsBody = document.getElementById('ratingsBody');
const closeRatings = document.getElementById('closeRatings');

const finalModal = document.getElementById('finalModal');
const finalBody = document.getElementById('finalBody');
const closeFinal = document.getElementById('closeFinal');

const studyArea = document.getElementById('studyArea');
const cardTerm = document.getElementById('cardTerm');
const cardDef = document.getElementById('cardDef');
const showAnswer = document.getElementById('showAnswer');
const knowBtn = document.getElementById('knowBtn');
const dontKnowBtn = document.getElementById('dontKnowBtn');

const topGrid = document.getElementById('topGrid');
const mainContainer = document.getElementById('mainContainer');

let ws = null;
let showPlayers = false;
let amIAdmin = false;
let lastTurnTime = TURN_TIME;
let currentStudyCardId = null;

/* Helpers */
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }
function setAdminVisible(v){ amIAdmin = !!v; startBtn.style.display = v ? 'inline-block' : 'none'; ratingBtn.style.display = v ? 'inline-block' : 'none'; }

/* populate topics (keep placeholder) */
function populateTopics(topics, current){
  const prev = Array.from(topicSelect.selectedOptions).map(o => o.value) || [];
  topicSelect.innerHTML = '';
  const placeholder = document.createElement('option');
  placeholder.value = '';
  placeholder.disabled = true;
  placeholder.selected = true;
  placeholder.textContent = 'Выбор темы';
  topicSelect.appendChild(placeholder);
  topics.forEach(t => {
    const opt = document.createElement('option'); opt.value = t; opt.textContent = t;
    if(prev.includes(t)) opt.selected = true;
    topicSelect.appendChild(opt);
  });
}
function getSelectedTopics(){ const v = topicSelect.value; return v ? [v] : []; }
function showPlayersList(names){ if(!showPlayers) return; playersBox.innerHTML = '<strong>Присоединившиеся:</strong><ul>' + (names||[]).map(n => '<li>' + escapeHtml(n) + '</li>').join('') + '</ul>'; playersBox.style.display = 'block'; }
function hidePlayersList(){ playersBox.style.display='none'; playersBox.innerHTML=''; }

/* choices enable/disable */
function enableChoices(){ choicesEls.forEach(el => { el.classList.remove('disabled','pressed','correct','wrong'); el.style.pointerEvents='auto'; el.style.opacity='1'; }); progress.style.display = 'block'; progressBar.style.width = '100%'; }
function disableChoices(){ choicesEls.forEach(el => { el.classList.add('disabled'); el.style.pointerEvents='none'; }); progress.style.display = 'none'; }

/* click handlers for choices */
function onChoiceClick(idx){ if(!ws || ws.readyState !== 1) return; choicesEls.forEach(el=>el.classList.remove('pressed')); choicesEls[idx].classList.add('pressed'); ws.send(JSON.stringify({type:'answer', choice: idx})); disableChoices(); }
choicesEls.forEach((el, idx) => el.addEventListener('click', () => onChoiceClick(idx)));

/* studyMethod: show full-width under top-grid but do NOT disturb right-stack buttons */
function showStudyMethodFullWidth(){
  if(studyMethodRow.parentElement !== studyMethodSlot){
    studyMethodSlot.appendChild(studyMethodRow);
    studyMethodRow.classList.add('top-wide');
    studyMethodRow.style.display = 'block';
  }
}
function hideStudyMethodFullWidth(){
  const leftStack = document.querySelector('.left-stack');
  if(leftStack && studyMethodRow.parentElement !== leftStack){
    leftStack.appendChild(studyMethodRow);
    studyMethodRow.classList.remove('top-wide');
    studyMethodRow.style.display = 'none';
  }
}
formatSelect.addEventListener('change', () => {
  if(formatSelect.value === 'study') showStudyMethodFullWidth(); else hideStudyMethodFullWidth();
});

/* collapse/restore menu for start/end of game — hide topGrid while game runs */
function collapseMenu(){
  if(!topGrid.classList.contains('hidden')){
    topGrid.classList.add('hidden');
    mainContainer.classList.add('menu-collapsed');
  }
}
function restoreMenu(){
  if(topGrid.classList.contains('hidden')){
    topGrid.classList.remove('hidden');
    mainContainer.classList.remove('menu-collapsed');
  }
}

/* image loader fallback with scrollIntoView after load */
function tryLoadImage(url, onSuccess, onFail){
  if(!url) { onFail && onFail(new Error('empty url')); return; }
  const img = new Image();
  img.onload = () => onSuccess(img);
  img.onerror = () => onFail && onFail(new Error('load failed ' + url));
  img.src = url;
}

/* setQuestion: collapse menu when showing image; scroll image to top after load */
function setQuestion(textOrDefinition, choices, turn_time, imageSrc){
  studyArea.style.display = 'none';
  enableChoices();
  imageWrap.innerHTML = '';
  imageWrap.style.display = 'none';
  qtext.textContent = '';

  if(imageSrc){
    collapseMenu();
    imageWrap.innerHTML = '<div style="color:var(--muted)">Загрузка изображения…</div>';
    imageWrap.style.display = 'flex';
    qtext.textContent = '';
    tryLoadImage(imageSrc, (imgEl) => {
      imageWrap.innerHTML = '';
      imgEl.alt = 'img';
      imgEl.style.borderRadius = '8px';
      imgEl.style.maxHeight = '80vh';
      imgEl.style.objectFit = 'contain';
      imageWrap.appendChild(imgEl);
      // scroll image area to top after a brief delay for layout to settle
      setTimeout(() => {
        try { imageWrap.scrollIntoView({ behavior: 'smooth', block: 'start' }); } catch (e) { window.scrollTo(0,0); }
      }, 50);
    }, (err) => {
      console.warn('thumb failed', err);
      try {
        const name = (new URL(imageSrc, location.origin)).pathname.split('/').pop();
        if(name){
          const fallback = location.origin + '/static/uploads/' + name;
          tryLoadImage(fallback, (img2) => {
            imageWrap.innerHTML = '';
            img2.alt = 'img';
            img2.style.borderRadius = '8px';
            img2.style.maxHeight = '80vh';
            img2.style.objectFit = 'contain';
            imageWrap.appendChild(img2);
            setTimeout(() => {
              try { imageWrap.scrollIntoView({ behavior: 'smooth', block: 'start' }); } catch (e) { window.scrollTo(0,0); }
            }, 50);
          }, (err2) => {
            console.error('fallback failed', err2);
            imageWrap.innerHTML = '<div style="color:var(--muted)">Не удалось загрузить изображение</div>';
          });
        } else {
          imageWrap.innerHTML = '<div style="color:var(--muted)">Не удалось загрузить изображение</div>';
        }
      } catch(e){
        console.error('fallback error', e);
        imageWrap.innerHTML = '<div style="color:var(--muted)">Не удалось загрузить изображение</div>';
      }
    });
  } else {
    imageWrap.style.display = 'none';
    qtext.textContent = textOrDefinition || '';
  }

  for(let i=0;i<4;i++){
    const text = choices && choices[i] ? choices[i] : '';
    choicesEls[i].textContent = String.fromCharCode(65+i) + ': ' + text;
  }
  lastTurnTime = turn_time || TURN_TIME;
  progressBar.style.width = '100%';
  progress.style.display = 'block';
}

/* message handling */
function handleMessage(msg){
  if(!msg || typeof msg !== 'object') return;
  if(msg.type === 'joined'){
    setAdminVisible(!!msg.is_admin);
    if(msg.topics) populateTopics(msg.topics, msg.topic || '');
    if(msg.num_questions != null) metaInQ.textContent = 'Вопросов в игре: ' + msg.num_questions;
    return;
  }
  if(msg.type === 'lobby'){
    if(msg.topics) populateTopics(msg.topics, msg.topic || '');
    if(msg.num_questions != null) metaInQ.textContent = 'Вопросов в игре: ' + msg.num_questions;
    if(showPlayers) showPlayersList(msg.players || []);
    return;
  }
  if(msg.type === 'game_started'){
    metaInQ.textContent = '';
    hidePlayersList();
    enableChoices();
    return;
  }

  function makeUrl(p){
    if(!p) return null;
    if(p.startsWith('http://') || p.startsWith('https://')) return p;
    const path = p.startsWith('/') ? p : '/' + p;
    return location.origin + path;
  }

  if(msg.type === 'new_question'){
    const rawThumb = msg.image_thumb || null;
    const rawImage = msg.image || null;
    const imageSrc = makeUrl(rawThumb || rawImage);
    setQuestion(msg.definition || msg.term || '', msg.choices || [], msg.turn_time || TURN_TIME, imageSrc);
    return;
  }
  if(msg.type === 'tick'){
    updateProgress(msg.remaining != null ? msg.remaining : 0, msg.turn_time || lastTurnTime);
    return;
  }
  if(msg.type === 'turn_result'){
    applyTurnResult(msg.correct_index, msg.results || []);
    return;
  }
  if(msg.type === 'game_over'){
    restoreMenu();
    renderFinalTable(msg.leaderboard || []);
    return;
  }
  if(msg.type === 'ratings'){
    renderRatings(msg.ratings || [], msg.topic || '');
    return;
  }
  if(msg.type === 'study_started'){
    studyArea.style.display = 'block';
    qtext.textContent = 'Режим обучения: ' + (msg.method || '');
    return;
  }
  if(msg.type === 'study_card'){
    studyArea.style.display = 'block';
    cardDef.style.display = 'none';
    cardTerm.textContent = msg.term || '';
    cardDef.textContent = msg.definition || '';
    currentStudyCardId = msg.card_id || null;
    return;
  }
  if(msg.type === 'study_result'){
    return;
  }
  if(msg.type === 'study_summary'){
    restoreMenu();
    renderFinalTable(msg.stats || []);
    return;
  }
}

/* progress */
function updateProgress(remaining, total){
  const t = total || lastTurnTime || TURN_TIME;
  const pct = Math.max(0, (remaining / t) * 100);
  progressBar.style.width = pct + '%';
  if(remaining <= 0) progress.style.display = 'none'; else progress.style.display = 'block';
}

/* apply turn result */
function applyTurnResult(correctIndex, results){
  for(let i=0;i<4;i++){
    choicesEls[i].classList.remove('pressed','wrong','correct');
    choicesEls[i].style.opacity = (i === correctIndex ? '1' : '0.6');
  }
  if(Number.isInteger(correctIndex) && choicesEls[correctIndex]){
    choicesEls[correctIndex].classList.add('correct');
  }
  const pressed = document.querySelector('.choice.pressed');
  if(pressed){
    const pressedIdx = choicesEls.indexOf(pressed);
    if(pressedIdx !== -1 && pressedIdx !== correctIndex){
      choicesEls[pressedIdx].classList.add('wrong');
    }
  }
  disableChoices();
}

/* final and ratings rendering */
function renderFinalTable(finalList){
  finalBody.innerHTML = '';
  (finalList || []).forEach((item, idx) => {
    const tr = document.createElement('tr');
    let cls = '';
    let medal = '';
    if(idx === 0){ cls = 'result-1'; medal = '🏆 '; }
    else if(idx === 1){ medal = '🥈 '; }
    else if(idx === 2){ medal = '🥉 '; }
    tr.className = cls;
    tr.innerHTML = '<td>' + (idx+1) + '</td>'
                 + '<td>' + medal + escapeHtml(item.name || '') + '</td>'
                 + '<td>' + (item.points||0) + '</td>'
                 + '<td>' + (item.correct||0) + '</td>';
    finalBody.appendChild(tr);
  });
  finalModal.style.display = 'flex';
}
function renderRatings(ratings, topic){
  ratingsBody.innerHTML = '';
  (ratings || []).forEach((r, idx) => {
    const tr = document.createElement('tr');
    let medal = '';
    if(idx === 0) medal = '🏆 ';
    else if(idx === 1) medal = '🥈 ';
    else if(idx === 2) medal = '🥉 ';
    tr.innerHTML = '<td>' + (idx+1) + '</td>'
                 + '<td>' + medal + escapeHtml(r.name || '') + '</td>'
                 + '<td>' + (r.total_points||0) + '</td>'
                 + '<td>' + (r.total_correct||0) + '</td>';
    ratingsBody.appendChild(tr);
  });
  ratingsModal.style.display = 'flex';
}

/* study controls */
showAnswer.addEventListener('click', () => { cardDef.style.display = 'block'; });
knowBtn.addEventListener('click', () => {
  if(!ws || ws.readyState !== 1 || !currentStudyCardId) return;
  ws.send(JSON.stringify({type:'study_feedback', card_id: currentStudyCardId, result:'ok'}));
  currentStudyCardId = null; cardTerm.textContent = ''; cardDef.textContent = ''; cardDef.style.display = 'none';
});
dontKnowBtn.addEventListener('click', () => {
  if(!ws || ws.readyState !== 1 || !currentStudyCardId) return;
  ws.send(JSON.stringify({type:'study_feedback', card_id: currentStudyCardId, result:'wrong'}));
  currentStudyCardId = null; cardTerm.textContent = ''; cardDef.textContent = ''; cardDef.style.display = 'none';
});

/* WebSocket wiring */
joinBtn.addEventListener('click', () => {
  const name = nameInput.value.trim(); if(!name){ alert('Введите имя'); return; }
  if(ws && ws.readyState === 1){ alert('Уже подключены'); return; }
  try{ ws = new WebSocket(location.origin.replace(/^http/, 'ws') + '/ws'); } catch(e){ alert('Ошибка WebSocket'); return; }
  showPlayers = true;
  ws.onopen = ()=> { ws.send(JSON.stringify({type:'join', name})); };
  ws.onmessage = ev => { try{ const m = JSON.parse(ev.data); handleMessage(m); }catch(e){} };
  ws.onclose = ()=> { showPlayers=false; hidePlayersList(); ws=null; };
  ws.onerror = ()=> {};
});

/* Start: send start and collapse menu immediately, scroll to top so image appears at top */
startBtn.addEventListener('click', () => {
  if(!ws || ws.readyState !== 1){ alert('Нет соединения с сервером'); return; }
  if(!amIAdmin){ alert('Только админ может стартовать игру'); return; }
  const format = formatSelect.value || 'game';
  const topics = getSelectedTopics();
  const payload = {type:'start_game', format, topics};
  if(format === 'study') payload.study_method = studyMethodSelect.value || 'flashcards';
  ws.send(JSON.stringify(payload));
  metaInQ.textContent = '';
  showPlayers = false;
  hidePlayersList();
  collapseMenu();
  try { window.scrollTo({ top: 0, behavior: 'instant' }); } catch(e) { window.scrollTo(0,0); }
});

/* Ratings */
ratingBtn.addEventListener('click', () => {
  if(!ws || ws.readyState !== 1){ alert('Нет соединения с сервером'); return; }
  ws.send(JSON.stringify({type:'get_ratings'}));
});

closeRatings.addEventListener('click', ()=>{ ratingsModal.style.display = 'none'; });
closeFinal.addEventListener('click', ()=>{ finalModal.style.display = 'none'; });

window.addEventListener('beforeunload', () => { try{ if(ws) ws.close(); } catch(e){} });
</script>
</body>
</html>