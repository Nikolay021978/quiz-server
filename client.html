<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Quiz client</title>
<style>
:root{
  --bg: #07121a;
  --card: #0f1720;
  --glass: rgba(255,255,255,0.03);
  --muted: #bdbdbd;
  --accent: #1e90ff;
  --ok: #00c853;
  --bad: #ff3860;
  --gutter: 14px;
  --control-height:48px;
  --side-w:160px;
  --choice-radius:12px;
  --choice-shadow: 0 8px 24px rgba(0,0,0,0.55);
  --btn-shadow: 0 6px 18px rgba(0,0,0,0.45);
  --btn-bg: var(--accent);
  --btn-color: #ffffff;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter, system-ui, Roboto, Arial;background:var(--bg);color:#fff;-webkit-font-smoothing:antialiased}

/* --- Disable native pull-to-refresh and overscroll gestures generally --- */
html, body {
  overscroll-behavior-y: none;
  -webkit-overflow-scrolling: auto;
  touch-action: pan-y;
}
.container, .card, .image-wrap, #mainContainer {
  overscroll-behavior: none;
  -webkit-overflow-scrolling: auto;
}

/* --- Layout and UI --- */
.container{max-width:1100px;margin:14px auto;padding:18px;display:flex;flex-direction:column;gap:18px}
.top-grid{display:grid;grid-template-columns:1fr var(--side-w);gap:var(--gutter);align-items:start}
.field{display:flex;flex-direction:column;gap:var(--gutter)}
.field input, .field select{
  height:var(--control-height);
  width:100%;
  padding:0 14px;
  border-radius:10px;
  border:1px solid rgba(255,255,255,0.04);
  background:var(--glass);
  color:#fff;
  font-size:15px;
  outline:none;
  transition:box-shadow .14s, transform .08s, border-color .08s;
}
.field input::placeholder{ color: rgba(255,255,255,0.55) }
.field input:focus, .field select:focus{ box-shadow:0 6px 18px rgba(30,144,255,0.08); border-color: rgba(30,144,255,0.14) }

.btn{
  height:var(--control-height);
  border-radius:10px;
  border:0;
  font-size:15px;
  cursor:pointer;
  padding:0 14px;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  width:100%;
  transition:transform .08s, box-shadow .12s, opacity .12s;
  box-shadow: var(--btn-shadow);
  background: var(--btn-bg);
  color: var(--btn-color);
}
.btn:active{ transform:translateY(2px) }
.btn:disabled{ opacity:0.55; cursor:default; transform:none; box-shadow:none }

#join{ --btn-bg: #800020; --btn-color:#fff; font-weight:700 }
#rating{ --btn-bg: #ffd54f; --btn-color:#111; font-weight:700 }
#start{ --btn-bg: #10b981; --btn-color:#042010; font-weight:800 }

.card{
  padding:16px;
  background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.006));
  border-radius:12px;
  display:flex;
  flex-direction:column;
  gap:12px;
  border:1px solid rgba(255,255,255,0.03);
  box-shadow: 0 8px 30px rgba(0,0,0,0.5);
}
.qtext{ font-size:20px; text-align:center; margin:6px 0; font-weight:700 }
.meta{ font-size:13px; color:var(--muted); text-align:center }

.image-wrap{ display:flex; flex-direction:column; align-items:center; gap:8px; overflow:hidden }
.image-wrap img{ max-width:100%; max-height:48vh; border-radius:8px; object-fit:contain }

.progress{ height:10px; background:rgba(255,255,255,0.03); border-radius:8px; overflow:hidden; margin:10px auto; width:100% }
.progress>i{ display:block; height:100%; background:linear-gradient(90deg,#ffd54f,#ff6b6b); width:0%; transition:width .18s linear }

/* ====== CHOICES: allow multiline, prevent one-letter orphans ====== */
.choices{
  display:grid;
  grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
  gap:12px;
  margin:0;
  width:100%;
  justify-items:stretch;
  align-items:stretch;
  box-sizing:border-box;
}

/* increased font size by ~2px compared to previous baseline */
.choice{
  padding: clamp(10px, 2vw, 14px);
  border-radius:var(--choice-radius);
  font-weight:800;
  color:#042010;
  background:#e6eefb;
  min-height:64px;
  text-align:center;
  cursor:pointer;
  user-select:none;
  display:flex;
  align-items:center;
  justify-content:center;
  transition:transform .12s, box-shadow .12s;
  box-shadow: var(--choice-shadow);
  white-space: normal;           /* allow wrapping */
  overflow-wrap: break-word;     /* break long words if needed */
  word-break: normal;
  hyphens: auto;
  font-size: clamp(15px, 2.2vw, 18px); /* increased by ~2px */
  line-height:1.15;
}
.choice:hover{ transform:translateY(-4px); box-shadow:0 14px 36px rgba(0,0,0,0.45) }
.choice.disabled{ opacity:0.6; pointer-events:none }
.choice.pressed{ transform:translateY(3px); box-shadow:0 6px 18px rgba(0,0,0,0.3) }
.choice.correct{ border:4px solid var(--ok); background:#e7ffef }
.choice.wrong{ border:4px solid var(--bad); background:#ffe6ec }
.choice .choice-label{ display:block; padding:6px 8px; color: #042010; font-weight:800; font-size:17px; } /* increased label font by ~2px */

.choice img.choice-img{ max-width:100%; max-height:120px; object-fit:contain; border-radius:8px; display:block }

.lobby-header{ display:flex; align-items:center; justify-content:space-between; gap:12px }
.start-wrapper{ min-width:140px }
.players-list{ font-size:13px; color:var(--muted); margin-top:6px }

/* Modal (results) styling revised: make modal-card scrollable and limited height */
.modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.6); z-index:60 }
.modal.show{ display:flex }

/* modal-card: limit height, use column layout so inner content can scroll */
.modal-card{
  width:min(920px,calc(100% - 40px));
  max-height: calc(100vh - 80px);
  background:#081019;
  border-radius:12px;
  padding:18px;
  color:#fff;
  box-shadow:0 20px 60px rgba(0,0,0,0.6);
  display:flex;
  flex-direction:column;
  gap:12px;
  overflow:hidden;
}
.modal-close{ background:transparent; border:0; color:var(--muted); cursor:pointer; font-size:16px; padding:6px 10px; border-radius:8px }

/* container that wraps the table: flex-grow and allow internal scroll */
.modal-body {
  flex: 1 1 auto;
  overflow: auto;
  -webkit-overflow-scrolling: touch;
  padding-right:6px;
}

/* ensure table is constrained and won't cause modal overflow */
#resultsTable {
  width:100%;
  border-collapse:collapse;
  text-align:left;
  font-size:14px;
  table-layout: fixed;
  max-width: 100%;
}

/* headers: slightly smaller */
#resultsTable thead th {
  padding:8px 10px;
  color:var(--muted);
  font-weight:700;
  text-transform:uppercase;
  vertical-align:middle;
  font-size:12px;
  border-bottom:1px solid rgba(255,255,255,0.06);
  overflow:hidden;
  text-overflow:ellipsis;
}

/* column sizing tuned so "Игрок" gets smaller (fits ~5 letters now) */
#resultsTable thead th:nth-child(1) { width:56px; min-width:56px; max-width:72px; text-align:center; }
#resultsTable thead th:nth-child(3) { width:66px; min-width:56px; max-width:86px; text-align:center; }
#resultsTable thead th:nth-child(4) { width:96px; min-width:80px; max-width:120px; text-align:center; }

/* name column: reduced to fit ~5 characters (ch units approximate character width) */
#resultsTable thead th:nth-child(2) { width: calc(100% - 56px - 66px - 96px); min-width: calc(5ch + 6ch); text-align:left; }

/* body rows and cells */
#resultsTable tbody tr { border-bottom:1px solid rgba(255,255,255,0.03); }
#resultsTable tbody td {
  padding:10px 12px;
  vertical-align:middle;
  font-size:13px;
  color: #fff;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}

/* name cell: now limited to roughly 5 characters + slack */
#resultsTable tbody td:nth-child(2) {
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
  max-width: calc(5ch + 8ch); /* approx space for ~5 letters plus padding/glyph slack */
}

/* place and points center and strong */
#resultsTable tbody td:nth-child(1),
#resultsTable tbody td:nth-child(3),
#resultsTable thead th:nth-child(1),
#resultsTable thead th:nth-child(3) {
  text-align:center;
  font-weight:800;
}

/* last column center, keep compact */
#resultsTable tbody td:nth-child(4),
#resultsTable thead th:nth-child(4) {
  text-align:center;
  white-space:nowrap;
  overflow:hidden;
}

/* responsive tweaks */
@media (max-width:920px){
  .modal-card{ width: calc(100% - 32px); }
  #resultsTable { table-layout: auto; }
  #resultsTable thead th:nth-child(2) { width: auto; min-width: calc(5ch + 4ch); }
  #resultsTable tbody td:nth-child(2) { max-width: calc(5ch + 6ch); }
}
@media (max-width:720px){
  #resultsTable tbody td:nth-child(2) { max-width: calc(4ch + 6ch); }
  #resultsTable thead th:nth-child(3) { width:66px; }
  #resultsTable thead th:nth-child(4) { width:100px; }
}
@media (max-width:520px){
  #resultsTable { font-size:13px; }
  #resultsTable thead th { font-size:11px; padding:6px 8px; }
  #resultsTable tbody td { font-size:12px; padding:8px 8px; white-space:normal; }
  #resultsTable tbody td:nth-child(2) { max-width:160px; white-space:normal; }
  #resultsTable thead th:nth-child(4), #resultsTable tbody td:nth-child(4) { max-width:100px; }
}

.hidden{ display:none }

@media (max-width:520px){
  .choices{ gap:10px; }
  .top-grid{ grid-template-columns: 1fr 120px }
  :root{ --control-height:44px; --side-w:120px }
  .choice{ font-size: 16px; padding: 10px; min-height:56px; }
  .choice .choice-label{ font-size:15px; }
}

/* ====== New styles for focus-up mode (hide top controls and lift game area) ====== */
.focus-up .top-grid,
.focus-up .lobby-header,
.focus-up #adminHint,
.focus-up .field,
.focus-up .start-wrapper {
  display: none !important;
}

.focus-up .container {
  padding-top: 8px;
}

.focus-up #gameCard {
  margin-top: 0 !important;
  transform: translateY(-6px);
  transition: transform .18s ease;
}

.focus-up #lobbyCard { display: none !important; }

/* smooth transitions for question card and choices */
#gameCard { transition: transform .18s ease, margin-top .18s ease; }
.choice:focus { outline: 3px solid rgba(30,144,255,0.12); outline-offset: 2px; }
</style>
</head>
<body>
<div class="container" id="mainContainer">
  <div class="top-grid">
    <div>
      <div class="field">
        <input id="name" placeholder="Укажите Имя" aria-label="Ваше имя" autocomplete="off" />
        <select id="topic" aria-label="Выбор темы"><option value="" disabled selected>Выберите тему</option></select>
      </div>
    </div>

    <div style="display:flex;flex-direction:column;gap:var(--gutter)">
      <div>
        <div class="field">
          <button id="join" class="btn" type="button" disabled>Соединить</button>
          <button id="rating" class="btn" type="button" disabled>Рейтинг</button>
        </div>
      </div>
    </div>
  </div>

  <div class="card" id="lobbyCard">
    <div class="lobby-header">
      <div>
        <strong>Присоединившиеся</strong>
        <div id="playersBox" class="players-list">Никто не присоединился</div>
      </div>
      <div class="start-wrapper">
        <button id="start" class="btn" type="button" disabled>Старт</button>
      </div>
    </div>
    <div id="adminHint" style="font-size:13px;color:var(--muted)"></div>
  </div>

  <div class="card hidden" id="gameCard" aria-live="polite">
    <div class="qtext" id="qtext"></div>
    <div class="meta" id="metaInQ"></div>
    <div class="image-wrap" id="imageWrap" style="display:none"></div>
    <div class="progress" id="progress" style="display:none"><i id="progressBar"></i></div>

    <div class="choices" id="choices" style="display:none" aria-hidden="true">
      <div class="choice" id="c0" role="button" tabindex="0" data-choice=""></div>
      <div class="choice" id="c1" role="button" tabindex="0" data-choice=""></div>
      <div class="choice" id="c2" role="button" tabindex="0" data-choice=""></div>
      <div class="choice" id="c3" role="button" tabindex="0" data-choice=""></div>
    </div>
  </div>
</div>

<!-- Updated modal: results table with icons for correct/incorrect -->
<div id="modal" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal-card" role="document" aria-labelledby="modalTitle">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
      <div class="modal-title" id="modalTitle" style="font-weight:800;font-size:18px">Итоги игры</div>
      <button id="modalClose" class="modal-close" aria-label="Закрыть окно результатов">✕</button>
    </div>

    <div class="modal-body" style="margin-top:4px">
      <table id="resultsTable" style="width:100%;border-collapse:collapse;text-align:left">
        <thead>
          <tr>
            <th>Место</th>
            <th>Игрок</th>
            <th>Очки</th>
            <th aria-label="Количество корректных и некорректных ответов">
              <svg width="20" height="14" viewBox="0 0 20 14" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                <g transform="translate(0,0)">
                  <path d="M2 12v-6h3l1-4 4 6h4v4H2z" fill="#00c853"/>
                  <path d="M18 2v8h-3l-1 4-4-6H6V4h12z" fill="#ff3860" opacity="0.95"/>
                </g>
              </svg>
            </th>
          </tr>
        </thead>
        <tbody id="resultsBody"></tbody>
      </table>
    </div>

    <div style="margin-top:12px;text-align:right">
      <button id="modalCloseBottom" class="btn" style="min-width:120px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)">Закрыть</button>
    </div>
  </div>
</div>

<script>
/* Full client logic with improved results modal and renderChoices behavior */

const nameInput = document.getElementById('name');
const joinBtn = document.getElementById('join');
const startBtn = document.getElementById('start');
const ratingBtn = document.getElementById('rating');
const topicSelect = document.getElementById('topic');

const playersBox = document.getElementById('playersBox');
const adminHint = document.getElementById('adminHint');

const gameCard = document.getElementById('gameCard');
const qtext = document.getElementById('qtext');
const metaInQ = document.getElementById('metaInQ');
const imageWrap = document.getElementById('imageWrap');
const progress = document.getElementById('progress');
const progressBar = document.getElementById('progressBar');
const choicesEls = [document.getElementById('c0'),document.getElementById('c1'),document.getElementById('c2'),document.getElementById('c3')];

const modal = document.getElementById('modal');
const modalClose = document.getElementById('modalClose');
const modalCloseBottom = document.getElementById('modalCloseBottom');

let ws = null;
let myName = '';
let amIAdmin = false;
let lastTurnTime = 15;
let myLastChoice = null;
let clearTimer = null;

function initUi(){
  topicSelect.disabled = true;
  startBtn.disabled = true;
  ratingBtn.disabled = true;
  joinBtn.disabled = true;
  nameInput.disabled = false;
  gameCard.classList.add('hidden');
  document.getElementById('choices').style.display='none';
  progress.style.display='none';
  playersBox.textContent='Никто не присоединился';
  adminHint.textContent='';
  qtext.textContent='';
  // ensure focus-up removed when UI is reset
  document.body.classList.remove('focus-up');
}
initUi();

function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }

function renderPlayers(names, adminName){
  if(!names || names.length===0){ playersBox.textContent='Никто не присоединился'; return; }
  playersBox.innerHTML = names.map(n => n === adminName ? `<div><strong>${escapeHtml(n)}</strong> <span style="color:var(--muted);font-weight:600">— Админ</span></div>` : `<div>${escapeHtml(n)}</div>`).join('');
}

function populateTopics(topics){
  topicSelect.innerHTML = '<option value="" disabled selected>Выберите тему</option>';
  (Array.isArray(topics)?topics:[]).forEach(t=> { const opt = document.createElement('option'); opt.value = t; opt.textContent = t; topicSelect.appendChild(opt); });
  topicSelect.disabled = false;
}

function updateProgress(remaining, turn_time){ lastTurnTime = turn_time || lastTurnTime; const clamped = Math.max(0, Math.min(Math.ceil(remaining), lastTurnTime)); const pct = (clamped / lastTurnTime) * 100; progress.style.display='block'; progressBar.style.width = pct + '%'; }

function showImage(src, thumb, question_text){
  imageWrap.innerHTML = '';
  const imgSrc = (thumb || src) || '';
  if(!imgSrc){ imageWrap.style.display='none'; return; }
  const img = document.createElement('img'); img.loading='lazy'; img.alt=''; img.onerror=()=>{ imageWrap.style.display='none'; }; img.src = imgSrc;
  imageWrap.appendChild(img); imageWrap.style.display='flex';
}

function clearChoiceStates(){
  if(clearTimer){ clearTimeout(clearTimer); clearTimer = null; }
  myLastChoice = null;
  choicesEls.forEach(el=>{ el.classList.remove('pressed','disabled','correct','wrong'); el.style.pointerEvents=''; el.setAttribute('aria-pressed','false'); el.setAttribute('aria-disabled','false'); el.innerHTML=''; el.title=''; });
  document.getElementById('choices').style.display = 'none';
}

/* renderChoices: insert NBSP before common one-letter russian words to avoid orphans */
function renderChoices(choices){
  clearChoiceStates();
  const container = document.getElementById('choices');
  container.style.display = 'grid';
  const safeChoices = Array.isArray(choices)?choices.slice(0,4):[];
  const singleLetterRegex = /\s([вскуоияёюае])\s/gi;
  const singleLetterEndRegex = /\s([вскуоияёюае])$/gi;
  for(let i=0;i<4;i++){
    const el = choicesEls[i];
    const raw = (i < safeChoices.length && safeChoices[i] != null) ? safeChoices[i] : '';
    el.dataset.choice = String(i);
    el.onclick = null; el.onkeydown = null;
    el.classList.remove('hidden','pressed','disabled','correct','wrong');
    el.setAttribute('aria-hidden','false');
    el.innerHTML = '';
    el.title = '';
    const isImg = typeof raw === 'string' && (raw.startsWith('/static/') || raw.startsWith('http://') || raw.startsWith('https://') || raw.match(/\.(png|jpe?g|gif|webp|bmp|svg)$/i));
    if(!isImg && String(raw).trim()){
      let text = String(raw);
      text = text.replace(singleLetterRegex, '\u00A0$1 ');
      text = text.replace(singleLetterEndRegex, '\u00A0$1');
      const lbl = document.createElement('span'); lbl.className='choice-label'; lbl.textContent = text;
      el.appendChild(lbl);
      el.title = String(raw);
      el.onclick = ()=>chooseAnswer(i);
      el.onkeydown = (e)=>{ if(e.key==='Enter' || e.key===' ') chooseAnswer(i); };
    } else if(isImg){
      const img = document.createElement('img'); img.className='choice-img'; img.loading='lazy'; img.alt='option'; img.onerror=()=>{ img.style.display='none'; };
      img.src = raw; el.appendChild(img);
      el.onclick = ()=>chooseAnswer(i);
      el.onkeydown = (e)=>{ if(e.key==='Enter' || e.key===' ') chooseAnswer(i); };
    } else {
      el.classList.add('hidden'); el.setAttribute('aria-hidden','true');
    }
  }
  if(window.ensureChoiceFit) window.ensureChoiceFit();
}

function chooseAnswer(choiceIdx){
  if(myLastChoice !== null) return;
  myLastChoice = choiceIdx;
  choicesEls.forEach((c, idx)=>{ c.classList.add('disabled'); c.style.pointerEvents='none'; c.setAttribute('aria-disabled','true'); if(idx===choiceIdx){ c.classList.add('pressed'); c.setAttribute('aria-pressed','true'); } else { c.classList.remove('pressed'); c.setAttribute('aria-pressed','false'); } });
  wsSend({type:'answer', choice: choiceIdx});
}

function showTurnResult(correct_index, results){
  if(clearTimer){ clearTimeout(clearTimer); clearTimer = null; }
  const myEntry = results && results.find(r=>r.name === myName);
  const myChoiceIdx = myEntry ? myEntry.choice : myLastChoice;
  choicesEls.forEach((el, idx) => {
    el.classList.remove('pressed');
    if(idx === correct_index){ el.classList.add('correct'); el.classList.remove('wrong'); }
    else if(myChoiceIdx != null && idx === myChoiceIdx && myChoiceIdx !== correct_index){ el.classList.add('wrong'); el.classList.remove('correct'); }
    else { el.classList.remove('correct','wrong'); }
    el.classList.add('disabled'); el.style.pointerEvents='none'; el.setAttribute('aria-disabled','true');
  });
}

function scheduleClearAfter(ms=1800){
  if(clearTimer){ clearTimeout(clearTimer); clearTimer = null; }
  clearTimer = setTimeout(()=>{ clearTimer = null; clearChoiceStates(); progress.style.display='none'; imageWrap.style.display='none'; qtext.textContent=''; }, ms);
}

/* --- WebSocket helpers --- */
function wsUrl(){ return (location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host + '/ws'; }

function connectWebSocket(name){
  if(ws && (ws.readyState === 1 || ws.readyState === 0)) return;
  ws = new WebSocket(wsUrl());
  ws.addEventListener('open', ()=>{ ws.send(JSON.stringify({type:'join', name: name})); });
  ws.addEventListener('message', (ev)=>{ try{ const m = JSON.parse(ev.data); handleMessage(m); } catch(e){ console.warn('msg parse', e); } });
  ws.addEventListener('close', ()=>{ ws = null; initUi(); });
  ws.addEventListener('error', ()=>{ console.warn('ws error'); });
}

function wsSend(obj){
  try{
    const s = JSON.stringify(obj);
    if(ws && ws.readyState === 1){ ws.send(s); return true; }
    return false;
  }catch(e){ console.warn('ws send failed', e); return false; }
}

/* --- New showModal implementation for results --- */
function showModal(title, rows){
  document.getElementById('modalTitle').textContent = title || 'Итоги игры';
  const body = document.getElementById('resultsBody');
  body.innerHTML = '';

  (Array.isArray(rows) ? rows : []).forEach((r, idx) => {
    const place = idx + 1;
    const name = r.name || r.player || '';
    const points = Number(r.total_points ?? r.points ?? 0);
    const correct = Number(r.correct ?? r.total_correct ?? r.correct_answers ?? 0);
    const incorrect = Number(r.incorrect ?? r.wrong ?? r.incorrect_answers ?? 0);

    const medal = place === 1 ? '🏆' : (place === 2 ? '🥈' : (place === 3 ? '🥉' : ''));

    const ciHtml = `
      <div style="display:inline-flex;gap:10px;align-items:center;justify-content:center">
        <span title="Верных" style="display:inline-flex;align-items:center;color:#00c853;font-weight:700">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <path d="M12 4l5 8h-3v8h-4v-8H7l5-8z" fill="#00c853"/>
          </svg>
          <span style="margin-left:6px">${correct}</span>
        </span>
        <span title="Неверных" style="display:inline-flex;align-items:center;color:#ff3860;font-weight:700">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <path d="M12 20l-5-8h3V4h4v8h4l-5 8z" fill="#ff3860"/>
          </svg>
          <span style="margin-left:6px">${incorrect}</span>
        </span>
      </div>`;

    const tr = document.createElement('tr');
    tr.style.borderBottom = '1px solid rgba(255,255,255,0.03)';
    tr.innerHTML = `
      <td style="padding:12px;text-align:center;font-weight:800">${place}${medal ? ' ' + medal : ''}</td>
      <td style="padding:12px;max-width:calc(5ch + 8ch);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${escapeHtml(name)}</td>
      <td style="padding:12px;text-align:center;font-weight:800">${points}</td>
      <td style="padding:12px;text-align:center">${ciHtml}</td>
    `;
    tr.querySelector('td:nth-child(4)').title = `Верных: ${correct}, Неверных: ${incorrect}`;
    body.appendChild(tr);
  });

  const modalEl = document.getElementById('modal');
  modalEl.classList.add('show'); modalEl.setAttribute('aria-hidden','false');

  document.getElementById('modalClose').onclick = hideModal;
  const bottom = document.getElementById('modalCloseBottom');
  if(bottom) bottom.onclick = hideModal;
}

function hideModal(){ const m = document.getElementById('modal'); m.classList.remove('show'); m.setAttribute('aria-hidden','true'); }

/* --- Message handling --- */
function handleMessage(msg){
  if(!msg || typeof msg !== 'object') return;
  if(msg.type === 'joined'){
    myName = msg.name || myName;
    amIAdmin = !!msg.is_admin;
    if(Array.isArray(msg.topics)) populateTopics(msg.topics);
    renderPlayers(msg.players || [], msg.is_admin ? myName : null);
    topicSelect.disabled = false;
    startBtn.disabled = !(amIAdmin && !!topicSelect.value);
    ratingBtn.disabled = !topicSelect.value;
    return;
  }
  if(msg.type === 'lobby'){
    if(Array.isArray(msg.topics)) populateTopics(msg.topics);
    renderPlayers(msg.players || [], msg.admin);
    if(msg.admin) adminHint.textContent = msg.admin === myName ? 'Вы — админ' : `Админ: ${msg.admin}`;
    startBtn.disabled = !(amIAdmin && !!topicSelect.value);
    ratingBtn.disabled = !topicSelect.value;
    // ensure top controls visible when lobby is shown
    document.body.classList.remove('focus-up');
    return;
  }
  if(msg.type === 'game_started'){
    document.getElementById('lobbyCard').classList.add('hidden');
    gameCard.classList.remove('hidden');
    // if game started (possibly by another client), hide top controls and lift question area
    document.body.classList.add('focus-up');
    setTimeout(()=>{
      const gc = document.getElementById('gameCard');
      if (gc && typeof gc.scrollIntoView === 'function') gc.scrollIntoView({ behavior: 'smooth', block: 'start' });
      const firstChoice = document.getElementById('c0');
      if (firstChoice) firstChoice.focus();
    }, 90);
    return;
  }
  if(msg.type === 'new_question'){
    document.getElementById('choices').style.display = 'grid';
    gameCard.classList.remove('hidden');
    clearChoiceStates();
    const imageSrc = msg.image || null; const thumb = msg.image_thumb || null;
    if(imageSrc || thumb){ qtext.textContent = ''; showImage(imageSrc, thumb, msg.question_text || ''); } else { qtext.textContent = msg.question_text || msg.term || ''; imageWrap.style.display = 'none'; }
    renderChoices(msg.choices || []);
    lastTurnTime = msg.turn_time || lastTurnTime;

    // поднять вопрос в видимую область и фокусировать первый вариант
    setTimeout(() => {
      const gc = document.getElementById('gameCard');
      if (gc && typeof gc.scrollIntoView === 'function') gc.scrollIntoView({ behavior: 'smooth', block: 'start' });
      const firstChoice = document.getElementById('c0');
      if (firstChoice) firstChoice.focus();
    }, 60);
    return;
  }
  if(msg.type === 'tick'){
    updateProgress(msg.remaining || 0, msg.turn_time || lastTurnTime);
    return;
  }
  if(msg.type === 'turn_result'){
    const correct_index = (typeof msg.correct_index === 'number') ? msg.correct_index : null;
    if(correct_index !== null){
      showTurnResult(correct_index, Array.isArray(msg.results) ? msg.results : []);
      scheduleClearAfter(1600);
    } else {
      document.getElementById('choices').style.display='none';
      progress.style.display='none';
      imageWrap.style.display='none';
      qtext.textContent='';
    }
    return;
  }
  if(msg.type === 'game_over'){
    document.getElementById('lobbyCard').classList.remove('hidden');
    gameCard.classList.add('hidden');
    const lb = Array.isArray(msg.leaderboard) ? msg.leaderboard : [];
    const rows = lb.map(r => ({ name: r.name || '', total_points: r.points || 0, correct: r.correct || 0, incorrect: r.incorrect || 0 }));
    showModal('Итоги игры', rows);
    // вернуть интерфейс обратно
    document.body.classList.remove('focus-up');
    return;
  }
  if(msg.type === 'ratings'){
    const list = Array.isArray(msg.ratings) ? msg.ratings : [];
    showModal(`Рейтинг — ${msg.topic || ''}`, list);
    return;
  }
  if(msg.type === 'error'){
    alert(msg.message || 'Ошибка');
    return;
  }
}

/* --- UI events --- */
nameInput.addEventListener('input', ()=>{ joinBtn.disabled = !nameInput.value.trim(); });
joinBtn.addEventListener('click', ()=>{
  const stored = localStorage.getItem('quiz_name') || '';
  const raw = nameInput.value || '';
  const cleaned = String(raw).normalize('NFC').replace(/[\u0000-\u001F\u007F]+/g,'').trim().slice(0,48);
  const name = cleaned || stored || 'player';
  myName = name; localStorage.setItem('quiz_name', myName); connectWebSocket(name); nameInput.disabled = true; joinBtn.disabled = true;
});

topicSelect.addEventListener('change', ()=>{ startBtn.disabled = !(amIAdmin && !!topicSelect.value); ratingBtn.disabled = !topicSelect.value; });

startBtn.addEventListener('click', ()=>{
  if(!ws || ws.readyState !== 1){ alert('Нет соединения'); return; }
  if(!amIAdmin){ alert('Только админ может стартовать игру'); return; }
  const selectedTopic = topicSelect.value || '';
  if(!selectedTopic){ alert('Выберите тему'); return; }
  wsSend({type:'start_game', format: 'quiz', topics: [selectedTopic]});
  document.getElementById('lobbyCard').classList.add('hidden');

  // поднимаем окно с вопросом и скрываем верхние элементы для минимизации отвлечений
  document.body.classList.add('focus-up');

  // плавно прокрутить вопрос в начало видимой области
  setTimeout(() => {
    const gc = document.getElementById('gameCard');
    if (gc && typeof gc.scrollIntoView === 'function') gc.scrollIntoView({ behavior: 'smooth', block: 'start' });
    // фокус на первом варианте для удобства клавиатуры
    const firstChoice = document.getElementById('c0');
    if (firstChoice) firstChoice.focus();
  }, 80);
});

ratingBtn.addEventListener('click', ()=>{
  if(!ws || ws.readyState !== 1){ alert('Нет соединения'); return; }
  const t = topicSelect.value || ''; if(!t){ alert('Выберите тему'); return; }
  wsSend({type:'get_ratings', format: 'quiz', topic: t});
});

choicesEls.forEach((el, idx) => { el.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' ') chooseAnswer(idx); }); });

modalClose.addEventListener('click', hideModal);
if(modalCloseBottom) modalCloseBottom.addEventListener('click', hideModal);
modal.addEventListener('click', (ev)=>{ if(ev.target === modal) hideModal(); });

window.addEventListener('beforeunload', ()=>{ try{ if(ws) ws.close(); }catch(e){} });

/* keep placeholder visible on load; stored name is only fallback */
(function(){ /* intentionally do not set nameInput.value = stored to preserve placeholder */ })();

/* --- Improved touch handlers: allow scrolling inside modal and inner scrollable elements --- */
(function(){
  let startY = 0;
  let tracking = false;

  function findScrollableAncestor(el){
    while(el && el !== document.body && el !== document.documentElement){
      const style = window.getComputedStyle(el);
      const overflowY = style.overflowY;
      if((overflowY === 'auto' || overflowY === 'scroll') && el.scrollHeight > el.clientHeight) return el;
      el = el.parentElement;
    }
    if(document.documentElement.scrollHeight > document.documentElement.clientHeight) return document.documentElement;
    return null;
  }

  function onTouchStart(e){
    if(!e.touches || e.touches.length !== 1) return;
    startY = e.touches[0].clientY;
    const nearest = findScrollableAncestor(e.target);
    tracking = !!nearest && (nearest === document.documentElement || nearest === document.body) && (window.scrollY === 0 || document.documentElement.scrollTop === 0);
  }

  function onTouchMove(e){
    if(!e.touches || e.touches.length !== 1) return;
    const curY = e.touches[0].clientY;
    const deltaY = curY - startY;

    const nearest = findScrollableAncestor(e.target);
    if(nearest && nearest !== document.documentElement && nearest !== document.body){
      if(deltaY > 0 && nearest.scrollTop > 0) return;
      if(deltaY < 0 && (nearest.scrollTop + nearest.clientHeight) < nearest.scrollHeight) return;
    }

    if(tracking && deltaY > 0){
      e.preventDefault();
    }
  }

  function onTouchEnd(){
    tracking = false;
    startY = 0;
  }

  document.addEventListener('touchstart', onTouchStart, {passive: true});
  document.addEventListener('touchmove', onTouchMove, {passive: false});
  document.addEventListener('touchend', onTouchEnd, {passive: true});
  document.addEventListener('touchcancel', onTouchEnd, {passive: true});
})();

/* ensureChoiceFit: reset styles after resize/orientation change */
(function(){
  function ensureChoiceFit(){
    const container = document.getElementById('choices');
    if(!container) return;
    const choices = Array.from(container.querySelectorAll('.choice'));
    choices.forEach(el=>{
      el.style.whiteSpace = '';
      el.style.textOverflow = '';
      el.style.overflow = '';
    });
  }
  window.ensureChoiceFit = ensureChoiceFit;
  window.addEventListener('resize', ensureChoiceFit);
  window.addEventListener('orientationchange', ensureChoiceFit);
  setTimeout(ensureChoiceFit, 120);
})();
</script>
</body>
</html>